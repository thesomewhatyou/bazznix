name: "Release"
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release'
        required: true
        type: string

jobs:
  build-iso:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # Remove unneeded software to free up disk space
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      
      - uses: actions/checkout@main
        with:
          fetch-depth: 1
      
      - uses: DeterminateSystems/nix-installer-action@main
      
      - uses: DeterminateSystems/magic-nix-cache-action@main
      
      - uses: cachix/cachix-action@master
        with:
          name: bazznix
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      
      - name: Build ISO
        run: |
          echo "Building bazznix installer ISO..."
          nix build --accept-flake-config .#nixosConfigurations.installer.config.system.build.isoImage
          echo "Build completed. Contents of result/iso/:"
          ls -la result/iso/
          echo "ISO file details:"
          ls -lh result/iso/*.iso
      
      - name: Get ISO filename
        id: iso
        run: |
          ISO_FILE=$(ls result/iso/*.iso)
          ISO_NAME=$(basename "$ISO_FILE")
          echo "path=$ISO_FILE" >> $GITHUB_OUTPUT
          echo "name=$ISO_NAME" >> $GITHUB_OUTPUT
      
      - name: Upload ISO to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.iso.outputs.path }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload ISO artifact (for workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: bazznix-installer-iso
          path: ${{ steps.iso.outputs.path }}
          retention-days: 30